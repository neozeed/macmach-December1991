#!/bin/sh
# Please do not edit this file.  It is generated automatically from
# configure.in and a configure template.
configdirs=

#!/bin/sh

# Configuration script template
#   Copyright (C) 1988, 1990, 1991 Free Software Foundation, Inc.

#This file is part of GNU.

# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  */

# $Id: configure,v 1.22 1991/07/20 01:22:30 rich Exp $

#
# Shell script to create proper links to machine-dependent files in
# preparation for compilation.
#
# If configure succeeds, it leaves its status in config.status.
# If configure fails after disturbing the status quo, 
# 	config.status is removed.
#

remove=rm
hard_link=ln
symbolic_link='ln -s'

#for Test
#remove="echo rm"
#hard_link="echo ln"
#symbolic_link="echo ln -s"

progname=$0

# clear some things potentially inherited from environment.
ansi=
defaulttargets=
destdir=
fatal=
hostsubdir=
Makefile=Makefile
Makefile_in=Makefile.in
norecurse=
removing=
srcdir=
srctrigger=
target=
targets=
targetsubdir=
template=
verbose=

for arg in $*;
do
	case ${arg} in
	-ansi | +ansi)
		ansi=true
		;;
	-destdir=* | +destdir=* | +destdi=* | +destd=* | +dest=* | +des=* | +de=* | +d=*)
		destdir=`echo ${arg} | sed 's/[+-]d[a-z]*=//'`
		;;
	-forcesubdirs | +forcesubdirs | +forcesubdir | +forcesubdi | +forcesubd \
	| +forcesub | +forcesu | +forces | +force | +forc | +for | +fo | +f)
		forcesubdirs=${arg}
		;;
	-languages=* | +languages=* | +language=* | +languag=* \
		| +langua=* | +langu=* | +lang=* | +lan=* | +la=* \
		| +l=*)
		languages="${languages} `echo ${arg} | sed 's/[+-]l[a-z]*=//'`"
		;;
	-gas | +gas | +ga | +g)
		gas=yes
		;;
	-help | +h | +help)
		fatal=true
		;;
	-nfp | +nfp | +nf | +n)
		nfp=yes
		;;
	-norecurse | +norecurse)
		norecurse=true
		;;
	-rm | +rm)
		removing=${arg}
		;;
#	-srcdir=* | +srcdir=* | +srcdi=* | +srcd=* | +src=* | +sr=* | +s=*)
#		srcdir=`echo ${arg} | sed 's/[+-]s[a-z]*=//'`
#		;;
	-target=* | +target=* | +targe=* | +targ=* | +tar=* | +ta=* | +t=*)
		if [ -n "${targets}" ] ; then
			forcesubdirs="+forcesubdirs"
		fi

		newtargets="${targets} `echo ${arg} | sed 's/[+-]t[a-z]*=//'`"
		targets="${newtargets}"
		;;
	-template=* | +template=*)
		template=`echo ${arg} | sed 's/[+-]template=//'`
		;;
	+verbose | +verbos | +verbo | +verb | +ver | +ve | +v)
		verbose=${arg}
		;;
	-* | +*)
		(echo ;
		echo "Unrecognized option: \"${arg}\"". ;
		echo) 1>&2
		fatal=true
		;;
	*)
		if [ -n "${hosts}" ] ; then
			forcesubdirs="+forcesubdirs"
		fi

		newhosts="${hosts} ${arg}"
		hosts=${newhosts}
		;;
	esac
done

if [ -n "${verbose}" ] ; then
	echo `pwd`/configure $*
	echo targets=\"${targets}\"
fi

# process host and target only if not rebuilding configure itself or removing.
if [ -z "${template}" -a -z "${removing}" -a -z "${fatal}" ] ; then
	# Complain if an arg is missing
	if [ -z "${hosts}" ] ; then
		(echo ;
		echo "configure: No HOST specified." ;
		echo) 2>&1
		fatal=true
	fi
fi

if [ -n "${fatal}" -o "${hosts}" = "help" ] ; then
	(echo "Usage: configure HOST" ;
	echo ;
	echo "Options: [defaults in brackets]" ;
	echo " +ansi		configure w/ANSI library. [no ansi lib]" ;
	echo " +destdir=MYDIR	configure for installation into MYDIR. [/usr/local]" ;
	echo " +forcesubdirs	configure in subdirectories.  [in source directories]" ;
	echo " +lang=LANG	configure to build LANG. [gcc]" ;
	echo " +help		print this message. [normal config]" ;
	echo " +gas		configure the compilers for use with gas. [native as]" ;
	echo " +nfp		configure the compilers default to soft floating point. [hard float]" ;
	echo " +norecurse	configure this directory only. [recurse]" ;
	echo " +rm		remove this configuration. [build a configuration]" ;
	echo " +target=TARGET	configure for TARGET.  [TARGET = HOST]" ;
	echo " +template=TEM	rebuild configure using TEM. [normal config]" ;
	echo ;
	echo "Where HOST and TARGET are something like \"vax\", \"sun3\", \"encore\", etc." ;
	echo "Asking for more than one \"+target\" implies \"+forcesubdirs\".  Any other" ;
	echo "options given will apply to all targets.") 1>&2

	if [ -r config.status ] ; then
		cat config.status
	fi

	exit 1
fi

#### configure.in common parts come in here.
srcname="GDB"
srctrigger=main.c

## end of common part.

# are we rebuilding config itself?
if [ -n "${template}" ] ; then
	if [ ! -r ${template} ] ; then
		echo "Can't find template ${template}."
		exit 1
	fi

# prep the template
	sed -e '/^#### configure.in common parts come in here.$/,/^## end of common part.$/c\
#### configure.in common parts come in here.\
## end of common part.' \
	-e '/^#### configure.in per-host parts come in here.$/,/^## end of per-host part.$/c\
#### configure.in per-host parts come in here.\
## end of per-host part.' \
	-e '/^#### configure.in per-target parts come in here.$/,/^## end of per-target part.$/c\
#### configure.in per-target parts come in here.\
## end of per-target part.' \
	-e '/^#### configure.in post-target parts come in here.$/,/^## end of post-target part.$/c\
#### configure.in post-target parts come in here.\
## end of post-target part.' \
	< ${template} > template.new

	if [ -r configure.in ] ; then
		if [ -z "`grep '^# per\-host:' configure.in`" ] ; then
			echo `pwd`/configure.in has no "per-host:" line.
			exit 1
		fi

		if [ -z "`grep '^# per\-target:' configure.in`" ] ; then
			echo `pwd`/configure.in has no "per-target:" line.
			exit 1
		fi

		# split configure.in into common, per-host, per-target,
		# and post-target parts.  Post-target is optional.
		sed -e '/^# per\-host:/,$d' configure.in > configure.com
		sed -e '1,/^# per\-host:/d' -e '/^# per\-target:/,$d' configure.in > configure.hst
		if grep -s '^# post-target:' configure.in ; then
		  sed -e '1,/^# per\-target:/d' -e '/^# post\-target:/,$d' configure.in > configure.tgt
		  sed -e '1,/^# post\-target:/d' configure.in > configure.pos
		else
		  sed -e '1,/^# per\-target:/d' configure.in > configure.tgt
		  echo >configure.pos
		fi

		# and insert them
		sed -e '/^#### configure.in common parts come in here.$/  r configure.com' \
			-e '/^#### configure.in per\-host parts come in here.$/  r configure.hst' \
			-e '/^#### configure.in per\-target parts come in here.$/  r configure.tgt' \
			-e '/^#### configure.in post\-target parts come in here.$/  r configure.pos' \
			template.new > configure.new

		rm -f configure.com configure.tgt configure.hst configure.pos
	else
		echo Warning: no configure.in in `pwd`
		cat ${template} >> configure
	fi

	chmod a+x configure.new
	rm template.new
#	mv configure configure.old
	mv configure.new configure
	echo Rebuilt configure in `pwd`

	if [ -z "${norecurse}" ] ; then
		# If template is relative path, make it absolute for recursing.
		if echo "${template}" | grep -s '^/' ; then
		   true
		else
		   template=`pwd`/${template}
		fi

		while [ -n "${configdirs}" ] ; do
			# set configdir to car of configdirs, configdirs to cdr of configdirs
			set ${configdirs}; configdir=$1; shift; configdirs=$*

			if [ "`echo ${configdir}.*`" != "${configdir}.*" ] ; then
				targetspecificdirs=${configdir}.*
			else
				targetspecificdirs=
			fi

			for i in ${configdir} ${targetspecificdirs} ; do
				if [ -d $i ] ; then
					if [ -r $i/configure ] ; then
						(cd $i ;
							./configure +template=${template} ${verbose})
					else
						echo No configure script in `pwd`/$i
					fi
				else
					echo Warning: directory $i is missing.
				fi
			done
		done
	fi

	exit 0
fi

# some sanity checks on configure.in
if [ -z "${srctrigger}" ] ; then
	echo srctrigger not set in configure.in. `pwd` not configured.
	exit 1
fi

for host in ${hosts} ; do
	# Default other arg
	if [ -z "${targets}" -o -n "${defaulttargets}" ] ; then
		targets=${host}
		defaulttargets=true
	fi

	host_makefile_frag=config/hmake-${host}

#### configure.in per-host parts come in here.

if [ ! -f xconfig/${host} ]; then
	echo "No such host ${host}"
	exit 1
fi

#  We really shouldn't depend on there being a space after XM_FILE= ...
hostfile=`awk '$1 == "XM_FILE=" { print $2 }' <xconfig/$host`

## end of per-host part.


	for target in ${targets} ; do

		if [ -n "${verbose}" ] ; then
			echo "	target=\"${target}\""
		fi

		target_makefile_frag=config/tmake-${target}

#### configure.in per-target parts come in here.

if [ ! -f tconfig/${target} ]; then
	echo "No such target ${target}"
	exit 1
fi

if [ -z "${removing}" ] ; then
	cat xconfig/${host} tconfig/${target} | awk '$1 == "#msg" {
		print substr($0,6)}'
fi

#  We really shouldn't depend on there being a space after TM_FILE= ...
targetfile=`awk '$1 == "TM_FILE=" { print $2 }' <tconfig/$target`

host_makefile_frag=xconfig/${host}
target_makefile_frag=tconfig/${target}

# If hostfile (XM_FILE) and/or targetfile (TM_FILE) is not set in the
# ?config/* file, we don't make the corresponding links.  But we have
# to remove the xm.h files and tm.h files anyway, e.g. when switching
# from "configure host" to "configure none".
files=
links=
rm -f xm.h
if [ "${hostfile}" != "" ]; then
	files="${files} ${hostfile}"
	links="${links} xm.h"
fi
rm -f tm.h
if [ "${targetfile}" != "" ]; then
	files="${files} ${targetfile}"
	links="${links} tm.h"
fi

## end of per-target part.

		# Temporarily, we support only direct subdir builds.
		hostsubdir=Host-${host}
		targetsubdir=Target-${target}

		if [ -n "${removing}" ] ; then
			if [ -n "${forcesubdirs}" ] ; then
				if [ -d "${hostsubdir}" ] ; then
					rm -rf ${hostsubdir}/${targetsubdir}

					if [ -z "`(ls ${hostsubdir}) 2>&1 | grep Target-`" ] ; then
						rm -rf ${hostsubdir}
					fi
				else
					echo Warning: no `pwd`/${hostsubdir} to remove.
				fi
			else
				rm -f ${Makefile} config.status ${links}
			fi
		else
			if [ -n "${forcesubdirs}" ] ; then
				# check for existing status before allowing forced subdirs.
				if [ -f ${Makefile} ] ; then
					echo "${Makefile} already exists in source directory.  `pwd` not configured."
					exit 1
				fi

				if [ ! -d ${hostsubdir} ] ; then mkdir ${hostsubdir} ; fi
				cd ${hostsubdir}

				if [ ! -d ${targetsubdir} ] ; then mkdir ${targetsubdir} ; fi
				cd ${targetsubdir}

				srcdir=../..
			else
				# if not subdir builds, then make sure none exist.
				if [ -n "`(ls .) 2>&1 | grep Host-`" ] ; then
					echo "Configured subdirs exist.  `pwd` not configured."
					exit 1
				fi
			fi

			# Find the source files, if location was not specified.
			if [ -z "${srcdir}" ] ; then
				srcdirdefaulted=1
				srcdir=.
				if [ -n "${srctrigger}" -a ! -r ${srctrigger} ] ; then
					srcdir=..
				fi
			fi

			if [ -n "${srctrigger}" -a ! -r ${srcdir}/${srctrigger} ] ; then
				if [ -z "${srcdirdefaulted}" ] ; then
					echo "${progname}: Can't find ${srcname} sources in `pwd`/${srcdir}" 1>&2
				else
					echo "${progname}: Can't find ${srcname} sources in `pwd`/. or `pwd`/.." 1>&2
				fi

				echo \(At least ${srctrigger} is missing.\) 1>&2
				exit 1
			fi

			# Set up the list of links to be made.
			# ${links} is the list of link names, and ${files} is the list of names to link to.

			# Make the links.
			while [ -n "${files}" ] ; do
				# set file to car of files, files to cdr of files
				set ${files}; file=$1; shift; files=$*
				set ${links}; link=$1; shift; links=$*

				if [ ! -r ${srcdir}/${file} ] ; then
					echo "${progname}: cannot create a link \"${link}\"," 1>&2
					echo "since the file \"${file}\" does not exist." 1>&2
					exit 1
				fi

				${remove} -f ${link}
				rm -f config.status
				# Make a symlink if possible, otherwise try a hard link
				${symbolic_link} ${srcdir}/${file} ${link} 2>/dev/null || ${hard_link} ${srcdir}/${file} ${link}

				if [ ! -r ${link} ] ; then
					echo "${progname}: unable to link \"${link}\" to \"${srcdir}/${file}\"." 1>&2
					exit 1
				fi
				echo "Linked \"${link}\" to \"${srcdir}/${file}\"."
			done

			# Create a .gdbinit file which runs the one in srcdir
			# and tells GDB to look there for source files.

			case ${srcdir} in
			.)
				;;
			*)
				echo "dir ." > .gdbinit
				echo "dir ${srcdir}" >> .gdbinit
				echo "source ${srcdir}/.gdbinit" >> .gdbinit
				;;
			esac

			# Install a makefile, and make it set VPATH
			# if necessary so that the sources are found.
			# Also change its value of srcdir.

		# FIXME-someday: This business of always writing to .tem and mv back
		# is so that I don't screw things up while developing.  Once this
		# template is stable, these should be optimized. xoxorich.

			# Define macro CROSS_COMPILE in compilation if this is a cross-compiler.
			if [ "${host}" != "${target}" ] ; then
				echo "CROSS=-DCROSS_COMPILE" > ${Makefile}
				echo "ALL=start.encap" >> ${Makefile}
			else
				echo "ALL=all.internal" > ${Makefile}
			fi

			# set target, host, VPATH
			echo "host = ${host}" >> ${Makefile}
			echo "target = ${target}" >> ${Makefile}

			if [ -n "${forcesubdirs}" ] ; then
				echo "subdir = /${hostsubdir}/${targetsubdir}" >> ${Makefile}
			else
				echo "subdir =" >> ${Makefile}
			fi

		#	echo "workdir = `pwd`" >> ${Makefile}
			echo "VPATH = ${srcdir}" >> ${Makefile}

			# add "Makefile.in" (or whatever it's called)
			cat ${srcdir}/${Makefile_in} >> ${Makefile}

			# Conditionalize the makefile for this host.
			if [ -f ${srcdir}/${host_makefile_frag} ] ; then
				sed -e "/^####/  r ${srcdir}/${host_makefile_frag}" ${Makefile} > Makefile.tem
				mv Makefile.tem ${Makefile}
			fi

			# Conditionalize the makefile for this target.
			if [ -f ${srcdir}/${target_makefile_frag} ] ; then
				sed -e "/^####/  r ${srcdir}/${target_makefile_frag}" ${Makefile} > Makefile.tem
				mv Makefile.tem ${Makefile}
			fi

			# set srcdir
			sed "s@^srcdir = \.@srcdir = ${srcdir}@" ${Makefile} > Makefile.tem
			mv Makefile.tem ${Makefile}

			# set destdir
			if [ -n "${destdir}" ] ; then
				sed "s:^destdir =.*$:destdir = ${destdir}:" ${Makefile} > Makefile.tem
				mv Makefile.tem ${Makefile}
			fi

			# reset SUBDIRS
			sed "s:^SUBDIRS =.*$:SUBDIRS = ${configdirs}:" ${Makefile} > Makefile.tem
			mv Makefile.tem ${Makefile}

			# reset NONSUBDIRS
			sed "s:^NONSUBDIRS =.*$:NONSUBDIRS = ${noconfigdirs}:" ${Makefile} > Makefile.tem
			mv Makefile.tem ${Makefile}

			using=
			if [ -f ${srcdir}/${host_makefile_frag} ] ; then
				using=" using \"${host_makefile_frag}\""
			fi

			if [ -f ${srcdir}/${target_makefile_frag} ] ; then
				if [ -z "${using}" ] ; then
					andusing=" using \"${target_makefile_frag}\""
				else
					andusing="${using} and \"${target_makefile_frag}\""
				fi
			else
				andusing=${using}
			fi

			echo "Created \"${Makefile}\"" in `pwd`${andusing}.

#### configure.in post-target parts come in here.

case ${srcdir} in
  .)
    ;;
  *)
    grep -s "source ${srcdir}/.gdbinit" .gdbinit 2>/dev/null || \
      echo "source ${srcdir}/.gdbinit" >> .gdbinit
esac

cat ${srcdir}/alldeps.mak ${srcdir}/depend >>Makefile
## end of post-target part.

			if [ "${host}" = "${target}" ] ; then
				echo "Links are now set up for use with a ${target}." \
					> config.status
		#			| tee ${srcdir}/config.status
			else
				echo "Links are now set up for host ${host} and target ${target}." \
					> config.status
		#			| tee ${srcdir}/config.status
			fi

			originaldir=`pwd`
			cd ${srcdir}
		fi
	done # for each target

#	# Now build a Makefile for this host.
#	if [ -n "${forcesubdirs}" ] ; then
#		cd ${hostsubdir}
#		cat > GNUmakefile << E!O!F
## Makefile generated by configure for host ${host}.
#
#%:
#	for i in ${targets} ; do \
#		$(MAKE) -C Target-\$i \$@
#
#all clean stage1 stage2 stage3 stage4etags tags TAGS
#E!O!F
#	fi
done # for each host

# If there are subdirectories, then recurse. 

if [ -n "${norecurse}" -o -z "${configdirs}" ] ; then exit 0 ; fi

# configdirs is not null
for configdir in ${configdirs} ; do
	echo Configuring ${configdir}...
	specifics=
	commons=

	if [ -n "${defaulttargets}" ] ; then
		for host in ${hosts} ; do
			if [ -d ${configdir}.${host} ] ; then
				newspecifics="${specifics} ${host}"
				specifics=${newspecifics}
			else
				newcommons="${commons} ${host}"
				commons=${newcommons}
			fi # if target specific
		done # for each host

		if [ -n "${commons}" ] ; then
			if [ -d ${configdir} ] ; then
				(cd ${configdir} ;
					./configure ${commons} ${verbose} ${forcesubdirs} ${removing} +destdir=${destdir}) \
					| sed 's/^/	/'
			else
				echo Warning: directory \"${configdir}\" is missing.
			fi
		fi # if any common hosts

		if [ -n "${specifics}" ] ; then
			for host in ${specifics} ; do
				echo Configuring target specific directory ${configdir}.${host}...
				(cd ${configdir}.${host} ;
					./configure ${host} ${verbose} ${forcesubdirs} ${removing} +destdir=${destdir}) \
					| sed 's/^/	/'
			done # for host in specifics
		fi # if there are any specifics
	else

		for target in ${targets} ; do
			if [ -d ${configdir}.${target} ] ; then
				newspecifics="${specifics} ${target}"
				specifics=${newspecifics}
			else
				newcommons="${commons} +target=${target}"
				commons=${newcommons}
			fi

		done # check for target specific dir override

		if [ -n "${verbose}" ] ; then
			echo "	"commons=\"${commons}\"
			echo "	"specifics=\"${specifics}\"
		fi # if verbose

		if [ -n "${commons}" ] ; then
			if [ -d ${configdir} ] ; then
				(cd ${configdir} ;
					./configure ${hosts} ${verbose} ${forcesubdirs} ${removing} \
						${commons} +destdir=${destdir}) \
					| sed 's/^/	/'
			else
				echo Warning: directory \"${configdir}\" is missing.
			fi
		fi # if any commons

		if [ -n "${specifics}" ] ; then
			for target in ${specifics} ; do
				echo Configuring target specific directory ${configdir}.${target}...
				(cd ${configdir}.${target} ;
					./configure ${hosts} ${verbose} ${forcesubdirs} ${removing} \
						"+target=${target}" +destdir=${destdir}) \
					| sed 's/^/	/'
			done
		fi # if any specifics
	fi # not default targets
done

exit 0

#
# $Log: configure,v $
# Revision 1.22  1991/07/20  01:22:30  rich
# propogate gdb changes and destdir fix
#
# Revision 1.21  1991/07/20  00:55:20  gnu
# Roll in new configure that handles GDB.  Make sure that the "configure"
# that is checked-in reflects the latest "configure.in", which includes gdb.
#
# Revision 1.9  1991/07/06  04:35:51  gnu
# Fix bug in configure when iterating targets.
# Depend on alldeps.mak, not ${srcdir}/alldeps.mak, so it can be found
# in either spot.
#
# Revision 1.8  1991/07/05  00:04:58  gnu
# Thu Jul  4 14:47:06 1991  John Gilmore  (gnu at cygint.cygnus.com)
#
#         * configure.in, Makefile.in:  Avoid rebuilding "depend" as much.
#         Avoid declaring Makefile dependencies, because GNU Make stupidly
#         tries to update it if we do.
#
#         * coffread.c:  Revise for minor changes to bfd internal coff
#         indexes.
#
#         * configure:  If -template= is given a relative path, make it
#         absolute before recurring in subdirectories.
#
# Revision 1.7  1991/07/04  15:59:46  gnu
# Make gdb work with configure.  Only thing that doesn't work is the -list
# option (as far as I know).
#
# Revision 1.6  1991/06/04  07:28:16  gnu
# Change GDB over to GNU General Public License version 2.
#
# Revision 1.5  1991/05/19  07:26:54  rich
# configure changes and -opcode.h movement.
#
# Revision 1.4  1991/05/19  00:16:45  rich
# Configure for gdb.
#
# Revision 1.10  1991/05/04  00:58:38  rich
# Fix program name bug.
#
# Revision 1.9  1991/05/03  19:14:18  rich
# Changed getopt to libiberty, commented out an aborted attempt at host
# level Makefiles because it caused errors on +rm, add a warning for
# directories expected to be removed on +rm but that don't exist.
#
# Revision 1.8  1991/04/24  16:50:59  rich
# Three staging checkpoint.
#
# Revision 1.7  1991/04/17  01:34:47  rich
# Added getopt for binutils, fixed problem with host dependancies in
# configure.template.
#
# Revision 1.6  1991/04/16  00:18:44  rich
# Now handles multiple hosts and targets.
#
# Revision 1.5  1991/04/15  23:43:44  rich
# Now handles multiple hosts and targets.
#
# Revision 1.4  1991/04/13  02:11:03  rich
# Config cut 3.  We now almost install a29k.
#
# Revision 1.3  1991/04/11  02:41:54  rich
# Cut 2 config.  Subdirs.
#
#
#

#
# Local Variables:
# fill-column: 131
# End:
#

# end of configure.template
